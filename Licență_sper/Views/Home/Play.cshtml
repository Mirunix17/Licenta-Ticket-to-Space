@{
    ViewData["Title"] = "Play";
}

<!-- Modal "Launch your mission" -->
<div id="missionModal" class="mission-modal-overlay">
    <div class="mission-modal-card">
        <h1 class="mission-title">🚀 Launch your mission!</h1>
        <p class="mission-subtitle">Choose your journey, Commander.</p>
        <div class="mission-buttons">
            <button class="btn-mission" onclick="startGame('singleplayer')">
                <span class="btn-mission-icon">🤖</span>
                <span class="btn-mission-label">Singleplayer</span>
                <span class="btn-mission-desc">Play against AI pilots</span>
            </button>
            <button class="btn-mission" onclick="startGame('multiplayer')">
                <span class="btn-mission-icon">👥</span>
                <span class="btn-mission-label">Multiplayer</span>
                <span class="btn-mission-desc">Play with friends online</span>
            </button>
        </div>
    </div>
</div>

<!-- Game board -->
<div id="gameBoard" class="game-board-wrapper" style="display:none;">

    <button class="exit-btn" onclick="exitGame()">✕ Exit</button>

    <div class="zone-top">
        <div class="player-zone opponent" id="opponent1">
            <div class="player-label">👾 Opponent 1</div>
            <div class="cards-row">
                <img class="card-back-img" src="/images/cards/backcard.png" alt="back" />
                <img class="card-back-img" src="/images/cards/backcard.png" alt="back" />
                <img class="card-back-img" src="/images/cards/backcard.png" alt="back" />
                <img class="card-back-img" src="/images/cards/backcard.png" alt="back" />
            </div>
        </div>
        <div class="player-zone opponent" id="opponent2">
            <div class="player-label">👾 Opponent 2</div>
            <div class="cards-row">
                <img class="card-back-img" src="/images/cards/backcard.png" alt="back" />
                <img class="card-back-img" src="/images/cards/backcard.png" alt="back" />
                <img class="card-back-img" src="/images/cards/backcard.png" alt="back" />
            </div>
        </div>
        <div class="player-zone opponent" id="opponent3">
            <div class="player-label">👾 Opponent 3</div>
            <div class="cards-row">
                <img class="card-back-img" src="/images/cards/backcard.png" alt="back" />
                <img class="card-back-img" src="/images/cards/backcard.png" alt="back" />
                <img class="card-back-img" src="/images/cards/backcard.png" alt="back" />
            </div>
        </div>
    </div>

    <div class="zone-middle">
        <div class="zone-left">
            <div class="player-zone opponent vertical" id="opponent4">
                <div class="player-label">👾 Opp 4</div>
                <div class="cards-col">
                    <img class="card-back-img" src="/images/cards/backcard.png" alt="back" />
                    <img class="card-back-img" src="/images/cards/backcard.png" alt="back" />
                    <img class="card-back-img" src="/images/cards/backcard.png" alt="back" />
                </div>
            </div>
        </div>
        <div class="zone-map">
            <img src="/images/map.png" alt="Space Map" class="game-map" />
        </div>
        <div class="zone-right">
            <div class="player-zone opponent vertical" id="opponent5">
                <div class="player-label">👾 Opp 5</div>
                <div class="cards-col">
                    <img class="card-back-img" src="/images/cards/backcard.png" alt="back" />
                    <img class="card-back-img" src="/images/cards/backcard.png" alt="back" />
                    <img class="card-back-img" src="/images/cards/backcard.png" alt="back" />
                </div>
            </div>
        </div>
    </div>

    <div class="zone-bottom">

        <!-- Stanga: cartile mele -->
        <div class="my-hand-zone">
            <div class="player-label" style="color:#3fe0ff; font-size:0.8rem; margin-bottom:6px;">🧑‍🚀 Your Hand</div>
            <div class="my-cards-row" id="myCards">
                <div class="my-card-slot"><div class="card-count">0</div><img class="card-front empty" src="/images/cards/white.png" alt="white" /></div>
                <div class="my-card-slot"><div class="card-count">0</div><img class="card-front empty" src="/images/cards/blue.png" alt="blue" /></div>
                <div class="my-card-slot"><div class="card-count">0</div><img class="card-front empty" src="/images/cards/purple.png" alt="purple" /></div>
                <div class="my-card-slot"><div class="card-count">0</div><img class="card-front empty" src="/images/cards/magenta.png" alt="magenta" /></div>
                <div class="my-card-slot"><div class="card-count">0</div><img class="card-front empty" src="/images/cards/red.png" alt="red" /></div>
                <div class="my-card-slot"><div class="card-count">0</div><img class="card-front empty" src="/images/cards/orange.png" alt="orange" /></div>
                <div class="my-card-slot"><div class="card-count">0</div><img class="card-front empty" src="/images/cards/yellow.png" alt="yellow" /></div>
                <div class="my-card-slot"><div class="card-count">0</div><img class="card-front empty" src="/images/cards/green.png" alt="green" /></div>
                <div class="my-card-slot"><div class="card-count">0</div><img class="card-front empty" src="/images/cards/joker.png" alt="joker" /></div>
            </div>
        </div>

        <div class="bottom-divider"></div>

        <!-- Dreapta: banca -->
        <div class="bank-zone">
            <div class="player-label" style="color:rgba(255,214,107,0.8); font-size:0.8rem; margin-bottom:6px;">🏦 Bank</div>
            <div class="bank-row">

                <!-- Pile 1: backroute - nu se poate clickui -->
                <div class="deck-stack no-click" title="Route cards - not drawable">
                    <img class="deck-img" src="/images/cards/backroute.png" alt="route deck" style="top:0;left:0;" />
                    <img class="deck-img" src="/images/cards/backroute.png" alt="route deck" style="top:-3px;left:-3px;" />
                    <img class="deck-img" src="/images/cards/backroute.png" alt="route deck" style="top:-6px;left:-6px;" />
                    <img class="deck-img" src="/images/cards/backroute.png" alt="route deck" style="top:-9px;left:-9px;" />
                    <img class="deck-img" src="/images/cards/backroute.png" alt="route deck" style="top:-12px;left:-12px;" />
                    <div class="deck-label">Routes</div>
                </div>

                <!-- Pile 2: backroute - se poate clickui, trage 1 ruta -->
                <div class="deck-stack clickable" id="routeDeckDraw" title="Draw a route card">
                    <img class="deck-img" src="/images/cards/backroute.png" alt="route deck" style="top:0;left:0;" />
                    <img class="deck-img" src="/images/cards/backroute.png" alt="route deck" style="top:-3px;left:-3px;" />
                    <img class="deck-img" src="/images/cards/backroute.png" alt="route deck" style="top:-6px;left:-6px;" />
                    <img class="deck-img" src="/images/cards/backroute.png" alt="route deck" style="top:-9px;left:-9px;" />
                    <img class="deck-img" src="/images/cards/backroute.png" alt="route deck" style="top:-12px;left:-12px;" />
                    <div class="deck-label">Draw</div>
                </div>

                <div class="bank-inner-divider"></div>

                <!-- 5 carti deschise -->
                <img class="card-front bank-card" id="bankCard0" src="/images/cards/red.png" alt="bank card" />
                <img class="card-front bank-card" id="bankCard1" src="/images/cards/blue.png" alt="bank card" />
                <img class="card-front bank-card" id="bankCard2" src="/images/cards/yellow.png" alt="bank card" />
                <img class="card-front bank-card" id="bankCard3" src="/images/cards/green.png" alt="bank card" />
                <img class="card-front bank-card" id="bankCard4" src="/images/cards/joker.png" alt="bank card" />

                <div class="bank-inner-divider"></div>

                <!-- Pile 3: backcard - nu se poate clickui -->
                <div class="deck-stack no-click" title="Card deck - display only">
                    <img class="deck-img" src="/images/cards/backcard.png" alt="card deck" style="top:0;left:0;" />
                    <img class="deck-img" src="/images/cards/backcard.png" alt="card deck" style="top:-3px;left:-3px;" />
                    <img class="deck-img" src="/images/cards/backcard.png" alt="card deck" style="top:-6px;left:-6px;" />
                    <img class="deck-img" src="/images/cards/backcard.png" alt="card deck" style="top:-9px;left:-9px;" />
                    <img class="deck-img" src="/images/cards/backcard.png" alt="card deck" style="top:-12px;left:-12px;" />
                    <div class="deck-label">Cards</div>
                </div>

                <!-- Pile 4: backcard - se poate clickui, trage 2 carti random -->
                <div class="deck-stack clickable" id="cardDeckDraw" title="Draw 2 random cards">
                    <img class="deck-img" src="/images/cards/backcard.png" alt="card deck" style="top:0;left:0;" />
                    <img class="deck-img" src="/images/cards/backcard.png" alt="card deck" style="top:-3px;left:-3px;" />
                    <img class="deck-img" src="/images/cards/backcard.png" alt="card deck" style="top:-6px;left:-6px;" />
                    <img class="deck-img" src="/images/cards/backcard.png" alt="card deck" style="top:-9px;left:-9px;" />
                    <img class="deck-img" src="/images/cards/backcard.png" alt="card deck" style="top:-12px;left:-12px;" />
                    <div class="deck-label">Draw 2</div>
                </div>

            </div>
        </div>

    </div>
</div>

<style>
    .mission-modal-overlay {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 4rem 1rem;
    }

    .mission-modal-card {
        background: rgba(8,10,28,0.95);
        border: 1px solid rgba(63,224,255,0.2);
        border-radius: 20px;
        padding: 3rem 3.5rem;
        text-align: center;
        box-shadow: 0 0 60px rgba(63,224,255,0.1), 0 20px 60px rgba(0,0,0,0.6);
        max-width: 520px;
        width: 90%;
    }

    .mission-title {
        font-family: 'Orbitron', sans-serif;
        color: #3fe0ff;
        font-size: 2rem;
        margin-bottom: 0.5rem;
        text-shadow: 0 0 20px rgba(63,224,255,0.4);
    }

    .mission-subtitle {
        color: rgba(255,255,255,0.6);
        margin-bottom: 2rem;
    }

    .mission-buttons {
        display: flex;
        gap: 1.2rem;
        justify-content: center;
    }

    .btn-mission {
        background: rgba(255,255,255,0.04);
        border: 1px solid rgba(63,224,255,0.25);
        border-radius: 14px;
        padding: 1.4rem 2rem;
        color: white;
        cursor: pointer;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.4rem;
        min-width: 160px;
        transition: all 0.2s ease;
    }

        .btn-mission:hover {
            background: rgba(63,224,255,0.1);
            border-color: #3fe0ff;
            transform: translateY(-3px);
            box-shadow: 0 8px 30px rgba(63,224,255,0.15);
        }

    .btn-mission-icon {
        font-size: 2rem;
    }

    .btn-mission-label {
        font-family: 'Orbitron', sans-serif;
        font-size: 0.9rem;
        color: #3fe0ff;
    }

    .btn-mission-desc {
        font-size: 0.75rem;
        color: rgba(255,255,255,0.5);
    }

    .game-board-wrapper {
        position: fixed;
        inset: 0;
        grid-template-rows: 100px 1fr 150px;
        background: #05071a;
        gap: 3px;
        z-index: 200;
    }

    .exit-btn {
        position: absolute;
        top: 16px;
        right: 20px;
        z-index: 250;
        background: rgba(200,0,0,0.25);
        border: 1px solid rgba(255,80,80,0.4);
        color: rgba(255,150,150,0.9);
        border-radius: 8px;
        padding: 6px 14px;
        font-family: 'Orbitron', sans-serif;
        font-size: 0.75rem;
        cursor: pointer;
        transition: all 0.2s ease;
    }

        .exit-btn:hover {
            background: rgba(200,0,0,0.5);
            color: white;
        }

    .zone-top {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 2rem;
        padding: 6px 12px;
        background: rgba(0,0,0,0.45);
        border-bottom: 1px solid rgba(63,224,255,0.08);
    }

    .zone-middle {
        display: grid;
        grid-template-columns: 90px 1fr 90px;
        overflow: hidden;
    }

    .zone-left, .zone-right {
        background: rgba(0,0,0,0.45);
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .zone-left {
        border-right: 1px solid rgba(63,224,255,0.08);
    }

    .zone-right {
        border-left: 1px solid rgba(63,224,255,0.08);
    }

    .zone-map {
        overflow: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .game-map {
        width: 100%;
        height: 100%;
        object-fit: contain;
    }

    .zone-bottom {
        display: flex;
        align-items: center;
        justify-content: space-between;
        background: rgba(0,0,0,0.45);
        border-top: 1px solid rgba(63,224,255,0.08);
        padding: 8px 30px;
        gap: 1rem;
        overflow: visible;
    }

    .bottom-divider {
        width: 1px;
        height: 80%;
        background: rgba(63,224,255,0.15);
        flex-shrink: 0;
    }

    .bank-inner-divider {
        width: 1px;
        height: 80px;
        background: rgba(255,255,255,0.1);
        flex-shrink: 0;
        align-self: flex-end;
        margin-bottom: 4px;
    }

    .player-zone {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 4px;
    }

    .player-label {
        font-size: 0.65rem;
        color: rgba(255,255,255,0.45);
        font-family: 'Orbitron', sans-serif;
        white-space: nowrap;
    }

    .cards-row {
        display: flex;
        gap: 4px;
        align-items: flex-end;
    }

    .cards-col {
        display: flex;
        flex-direction: column;
        gap: 4px;
        align-items: center;
    }

    /* Cartile oponentilor cu PNG */
    .card-back-img {
        width: 30px;
        height: 45px;
        border-radius: 4px;
        object-fit: cover;
        flex-shrink: 0;
        box-shadow: 0 2px 6px rgba(0,0,0,0.4);
    }

    .my-hand-zone {
        display: flex;
        flex-direction: column;
        align-items: center;
        flex: 1;
    }

    .my-cards-row {
        display: flex;
        gap: 8px;
        align-items: flex-end;
        justify-content: center;
    }

    .my-card-slot {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 3px;
    }

    .card-count {
        font-size: 0.85rem;
        font-weight: bold;
        color: #3fe0ff;
        font-family: 'Orbitron', sans-serif;
        min-height: 18px;
    }

    .card-front {
        width: 54px;
        height: 80px;
        border-radius: 8px;
        border: 2px solid rgba(255,255,255,0.15);
        box-shadow: 0 4px 12px rgba(0,0,0,0.5);
        cursor: pointer;
        transition: transform 0.18s ease, box-shadow 0.18s ease;
        flex-shrink: 0;
        object-fit: cover;
        position: relative;
        display: block;
    }

        .card-front.empty {
            opacity: 0.35;
            cursor: default;
        }

    #myCards .card-front:hover:not(.empty) {
        transform: translateY(-24px) scale(1.3);
        box-shadow: 0 18px 36px rgba(63,224,255,0.35);
        z-index: 20;
    }

    .bank-card:hover {
        transform: translateY(-20px) scale(1.25);
        box-shadow: 0 16px 32px rgba(255,214,107,0.35);
        z-index: 20;
    }

    .bank-zone {
        display: flex;
        flex-direction: column;
        align-items: center;
        flex: 1;
    }

    .bank-row {
        display: flex;
        gap: 8px;
        align-items: flex-end;
        justify-content: center;
    }

    .deck-stack {
        position: relative;
        width: 54px;
        height: 80px;
        margin-top: 14px;
        flex-shrink: 0;
        transition: transform 0.18s ease;
    }

        .deck-stack.clickable {
            cursor: pointer;
        }

        .deck-stack.no-click {
            cursor: not-allowed;
            opacity: 0.7;
        }

        .deck-stack.clickable:hover {
            transform: translateY(-12px) scale(1.15);
        }

    .deck-img {
        position: absolute;
        width: 54px;
        height: 80px;
        border-radius: 8px;
        object-fit: cover;
        border: 1px solid rgba(255,255,255,0.15);
        box-shadow: 0 2px 6px rgba(0,0,0,0.4);
    }

    .deck-label {
        position: absolute;
        bottom: -18px;
        left: 50%;
        transform: translateX(-50%);
        font-size: 0.55rem;
        color: rgba(255,255,255,0.4);
        font-family: 'Orbitron', sans-serif;
        white-space: nowrap;
    }
</style>

@section Scripts {
    <script>
        var allCards = ['white','blue','purple','magenta','red','orange','yellow','green','joker'];
        var counts = {};

        function randomizeBankCards() {
            var shuffled = allCards.slice().sort(function() { return Math.random() - 0.5; });
            for (var i = 0; i < 5; i++) {
                document.getElementById('bankCard' + i).src = '/images/cards/' + shuffled[i] + '.png';
            }
        }

        function dealStartingHand() {
            allCards.forEach(function(c) { counts[c] = 0; });
            for (var i = 0; i < 4; i++) {
                counts[allCards[Math.floor(Math.random() * allCards.length)]]++;
            }
            updateHandUI();
        }

        function updateHandUI() {
            document.querySelectorAll('#myCards .my-card-slot').forEach(function(slot) {
                var img = slot.querySelector('img');
                if (img) {
                    var card = img.alt;
                    slot.querySelector('.card-count').textContent = counts[card];
                    if (counts[card] === 0) img.classList.add('empty');
                    else img.classList.remove('empty');
                }
            });
        }

        function flyCard(srcEl, cardName, onComplete) {
            var srcRect = srcEl.getBoundingClientRect();
            var targetSlot = null;
            document.querySelectorAll('#myCards .my-card-slot').forEach(function(slot) {
                var img = slot.querySelector('img');
                if (img && img.alt === cardName) targetSlot = slot;
            });
            var targetRect = targetSlot
                ? targetSlot.getBoundingClientRect()
                : { left: window.innerWidth / 2, top: window.innerHeight - 100, width: 54 };

            var flying = document.createElement('img');
            flying.src = '/images/cards/' + cardName + '.png';
            flying.style.cssText =
                'position:fixed;left:' + srcRect.left + 'px;top:' + srcRect.top + 'px;' +
                'width:' + srcRect.width + 'px;height:' + srcRect.height + 'px;' +
                'border-radius:8px;z-index:999;pointer-events:none;object-fit:cover;' +
                'transition:left 0.5s cubic-bezier(0.25,0.46,0.45,0.94),' +
                'top 0.5s cubic-bezier(0.25,0.46,0.45,0.94),transform 0.5s ease,opacity 0.5s ease;' +
                'box-shadow:0 0 30px rgba(63,224,255,0.6);';
            document.body.appendChild(flying);

            requestAnimationFrame(function() {
                requestAnimationFrame(function() {
                    flying.style.left = (targetRect.left + targetRect.width / 2 - srcRect.width / 2) + 'px';
                    flying.style.top = targetRect.top + 'px';
                    flying.style.transform = 'scale(1.2)';
                });
            });

            setTimeout(function() {
                flying.style.opacity = '0';
                setTimeout(function() { document.body.removeChild(flying); }, 200);
                if (onComplete) onComplete();
            }, 520);
        }

        function pickBankCard(index) {
            var bankCard = document.getElementById('bankCard' + index);
            var cardName = bankCard.src.split('/').pop().replace('.png', '');

            flyCard(bankCard, cardName, function() {
                counts[cardName]++;
                updateHandUI();
                var newCard = allCards[Math.floor(Math.random() * allCards.length)];
                bankCard.src = '/images/cards/' + newCard + '.png';
            });
        }

        function drawFromDeck() {
            // Trage 2 carti random, una dupa alta
            var card1 = allCards[Math.floor(Math.random() * allCards.length)];
            var card2 = allCards[Math.floor(Math.random() * allCards.length)];
            var deckEl = document.getElementById('cardDeckDraw');

            flyCard(deckEl, card1, function() {
                counts[card1]++;
                updateHandUI();
                // A doua carte zboara la 300ms dupa prima
                setTimeout(function() {
                    flyCard(deckEl, card2, function() {
                        counts[card2]++;
                        updateHandUI();
                    });
                }, 300);
            });
        }

        function startGame(mode) {
            document.getElementById('missionModal').style.display = 'none';
            document.getElementById('gameBoard').style.display = 'grid';
            randomizeBankCards();
            dealStartingHand();

            // Click pe cartile expuse din banca
            for (var i = 0; i < 5; i++) {
                (function(idx) {
                    document.getElementById('bankCard' + idx).addEventListener('click', function() {
                        pickBankCard(idx);
                    });
                })(i);
            }

            // Click pe pile-ul de carti normale (draw 2)
            document.getElementById('cardDeckDraw').addEventListener('click', drawFromDeck);
        }

        function exitGame() {
            document.getElementById('gameBoard').style.display = 'none';
            document.getElementById('missionModal').style.display = 'flex';
        }
    </script>
}
